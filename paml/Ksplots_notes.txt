#Since I can't get any of the pipelines to run, I'm gonna do
#the Ks plots myself. The involves redoing basically the whole
#pipeline using coding sequences and codon alignments rather than
#the original mRNA files. Will use these for downstream analyses too.
#The alignments will be much better quality than the ones MAFFT puts out
#via OrthoFinder. First I need to get the cds files from the evigene 
#assemblies, since I'm using the mRNA files right now and those are out 
#of reading frame. Copying these from the evigene folders in Joanna's 
#folder and mine for buceph. 

#Run each of these scripts for all files
perl -ne 'if(/^>(\S+)/){ $id=$1; $ok=($id=~m/t1$/); } print if $ok;' ../../Assemblies/evigene_tr2aacds4_bucephalophorus/okayset/R_bucephalophorus.okay.cds > R_bucephalophorus.t1okay.cds
python3 ../filter_evigene_assembly.py R_bucephalophorus.t1okay.cds > R_bucephalophorus.t1okay.filtered.cds

#Change file extensions
for file in *.cds; do mv -- "$file" "${file%.cds}.cds.fasta"; done

#Add species name to sequence IDs so they can be recovered later. Run this for each assembly file:
sed -i 's/>/>R_acetosella_/g' Alignments/assembly_cds_filtered/R_acetosella.t1okay.filtered.cds.fasta

#Run OrthoFinder -without- MSA on these cds files 

conda activate mark_orthofinder
mkdir OrthoFinder_cdna_buckwheat
cd OrthoFinder_cdna_buckwheat
nohup orthofinder -f ../assembly_cds_filtered/ -d -t 50 &

#Next we're doing the codon alignments. Change to phylo
#conda environment

conda activate mark_rumex_phylo
mkdir aa_MSUCLE_alignments_buckwheat

#Translate orthogroup sequences to protein
nohup python translate_orthogroup_seqs.py OrthoFinder_cdna_buckwheat/OrthoFinder/Results_Jun13/Orthogroup_Sequences/ orthogroup_AA_sequences_buckwheat/ &

#Before running alignment, delete all alignment files containing a single sequence (these are basically useless and there are a ton of them). 
#This takes a while to run since there are so many files. 

for file in orthogroup_AA_sequences_buckwheat/*; do seqcount=$(fgrep -o ">" $file | wc -l); if [ $seqcount -eq 1 ]; then rm $file; fi; done

#Run MUSCLE protein alignment with GNU parallel
ls orthogroup_AA_sequences_rhubarb/ | grep \.fa | nohup parallel -j 50 "muscle -in orthogroup_AA_sequences_rhubarb/{} -out aa_MUSCLE_alignments_rhubarb/{/.}_aligned.fa" &

#RevTrans needs python 2, so I'm putting it in a separate conda environment

conda activate mark_revtrans
nohup bash rumex_revtrans_alignments.sh &

#Note: RevTrans seems to be ignoring nucleotide sequences that don't start with a start codon. Probably OK. Can't do proper codon
#alignment this way anyway. They are almost entirely hastatulus sequences, which is maybe a bit concerning.... hey, as long as 
#there are enough genes leftover. 

#Filter codon alignments using Gblocks 

for file in rumex_codon_alignments_buckwheat/*; do Gblocks $file -t=c -b5=a; done
find rumex_codon_alignments_buckwheat/ -name *.fa-gb -exec mv {} rumex_codon_alignments_buckwheat_filtered/ \;
for file in rumex_codon_alignments_buckwheat_filtered/*; do awk '/^>/ {printf("\n%s\n",$0);next; } { printf("%s",$0);}  END {printf("\n");}' < "$file" > "${file}.fasta"; done
find rumex_codon_alignments_buckwheat_filtered/ -name "*.fa-gb" -delete
for f in rumex_codon_alignments_buckwheat_filtered/*; do sed -i 's/ //g' "$f"; done

#First step toward running PAML seems to be estimating gene trees for each orthogroup. I can probably do this using GNU parallel with IQ-TREE on the codon alignments. 

conda activate mark_rumex_phylo
ls ../../Alignments/rumex_codon_alignments_buckwheat_filtered/ | grep \.fasta | nohup parallel -j 50 "iqtree -s ../../Alignments/rumex_codon_alignments_buckwheat_filtered/{}" &

#Move IQtree files into folder in Phylogenies
find ../../Alignments/rumex_codon_alignments_buckwheat_filtered/ -name '*.fasta.*' -exec mv {} . \;

#Moving the tree files into a separate folder and compressing everything else
find ../buckwheat_codon_orthogroup_genetrees_allouts/ -name '*.fasta.treefile' -exec cp {} . \;

#There are only 26k tree files, so a bunch of the alignments seem to have failed. Ah well,
#this still seems like plenty. Probably lack of sequence info? Yes - IQtree only works on
#alignments of at least 3 sequences (duh, can't have a phylogeny of two species)

#Make PAML control files
ls ../../Phylogenies/codon_orthogroup_genetrees/ | grep \.treefile | parallel -j 30 "python make_paml_control_file.py ../../Phylogenies/codon_orthogroup_genetrees/{} ../../Alignments/rumex_codon_alignments/"

#Run PAML :) 
ls control_files/ | grep \.ctl | nohup parallel -j 30 "codeml control_files/{}" &

#Parse the PAML outputs:
python parse_paml_outputs.py ../../rumex_sequence_spnames.txt paml_results/

